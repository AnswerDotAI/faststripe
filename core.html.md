# core


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

<details open class="code-fold">
<summary>Exported source</summary>

``` python
stripe_api_url = 'https://api.stripe.com'
```

</details>

``` python
ep = first(eps, lambda x: x['data'] and len(x['data']) < 3)
ep
```

    {'data': [{'annotation': list,
       'default': None,
       'description': 'Specifies which fields in the response should be expanded.',
       'name': 'expand'},
      {'annotation': bool,
       'default': None,
       'description': "To request a new capability for an account, pass true. There can be a delay before the requested capability becomes active. If the capability has any activation requirements, the response includes them in the `requirements` arrays.\n\nIf a capability isn't permanent, you can remove it from the account by passing false. Some capabilities are permanent after they've been requested. Attempting to remove a permanent capability returns an error.",
       'name': 'requested'}],
     'doc_url': 'https://docs.stripe.com/api/capabilities/update',
     'op_id': 'PostAccountsAccountCapabilitiesCapability',
     'path': '/v1/accounts/{account}/capabilities/{capability}',
     'qparams': [],
     'summary': 'Update an Account Capability',
     'verb': 'post'}

## Parsing Endpoints

Now, with each of these descriptions, we can easily create a request
that we want on the fly. However, to make it a little bit nicer to use
in a library, we’ll go ahead and automatically generate classes with
proper signatures and docstrings that are then easily accessible in any
standard IDE.

``` python
path, *_ = partial_format(ep['path'])
req_args = stringfmt_names(path)
opt_args = ep['qparams']
anno_args = ep['data']

_mk_sig(req_args, opt_args, anno_args)
```

    <Signature (account, capability, expand: list = None, requested: bool = None)>

For organizing our APIs into resource groups, which the OpenAPI spec
tends to do, we’re going to parse the operation ID.

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/faststripe/blob/main/faststripe/core.py#L33"
target="_blank" style="float:right; font-size:smaller">source</a>

### op2nm

``` python

def op2nm(
    op_id
):

```

*Parse the operation ID to get the resource and name*

``` python
op2nm(ep['op_id'])
```

    ('accounts', ['account', 'capabilities', 'capability', 'post'])

``` python
stripe_key = os.environ['STRIPE_SECRET_KEY']
headers = {'Authorization': f'Bearer {stripe_key}'}
```

With this, we can now construct a entire OpenAPI verb with proper
documentation and nice repr inside Jupyter environments!

``` python
v = _OAPIVerb(url=stripe_api_url, hdrs=headers, client=None, **eps[0])
v
```

[account.get](https://docs.stripe.com/api/accounts/retrieve)(expand:
list = None): *Retrieve account*

Each endpoint includes a direct link to its documentation page. Due to
Stripe’s API organization, some links (like checkout endpoints) may
return 404s, but most core endpoints link correctly to their
documentation when you need additional context.

``` python
v?
```

``` python
def get(expand: list = None)(
    expand:list=None
):
```

    Retrieve account

    Parameters:
        expand: Specifies which fields in the response should be expanded.

**Type:** \_OAPIVerb

Let’s go ahead and group our verbs based on the resource they are apart
of. We can setup a repr to make discoverability of operations you can
perform easy.

``` python
verbs = L(eps).map(lambda x: _OAPIVerb(**x, url=stripe_api_url, hdrs=headers, client=None))
groups = {k.replace('-','_'): _OAPIVerbGroup(k,v) for k,v in groupby(verbs, 'res').items()}
res, g = first(groups.items())
g
```

- [account.get](https://docs.stripe.com/api/accounts/retrieve)(expand:
  list = None): *Retrieve account*
- [account.links_post](https://docs.stripe.com/api/account_links/create)(account:
  str = None, collect: str = None, collection_options: dict = None,
  expand: list = None, refresh_url: str = None, return_url: str = None,
  type: str = None): *Create an account link*
- [account.sessions_post](https://docs.stripe.com/api/account_sessions/create)(account:
  str = None, components: dict = None, expand: list = None): *Create an
  Account Session*

## StripeApi

Let’s go ahead and design a class since we need to store our API key and
for use in the headers for each of these classes.

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/faststripe/blob/main/faststripe/core.py#L98"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeApi

``` python

def StripeApi(
    api_key:NoneType=None, base_url:str='https://api.stripe.com'
):

```

*Initialize self. See help(type(self)) for accurate signature.*

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/faststripe/blob/main/faststripe/core.py#L131"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeApiAsync

``` python

def StripeApiAsync(
    api_key:NoneType=None, base_url:str='https://api.stripe.com'
):

```

*Initialize self. See help(type(self)) for accurate signature.*

``` python
sapi = StripeApi() # Uses `STRIPE_SECRET_KEY` env var by default
sapi
```

- [account](https://docs.stripe.com/api/account)
- [accounts](https://docs.stripe.com/api/accounts)
- [apple](https://docs.stripe.com/api/apple)
- [application](https://docs.stripe.com/api/application)
- [apps](https://docs.stripe.com/api/apps)
- [balance](https://docs.stripe.com/api/balance)
- [billing](https://docs.stripe.com/api/billing)
- [charges](https://docs.stripe.com/api/charges)
- [checkout](https://docs.stripe.com/api/checkout)
- [climate](https://docs.stripe.com/api/climate)
- [confirmation](https://docs.stripe.com/api/confirmation)
- [country](https://docs.stripe.com/api/country)
- [coupons](https://docs.stripe.com/api/coupons)
- [credit](https://docs.stripe.com/api/credit)
- [customer](https://docs.stripe.com/api/customer)
- [customers](https://docs.stripe.com/api/customers)
- [disputes](https://docs.stripe.com/api/disputes)
- [entitlements](https://docs.stripe.com/api/entitlements)
- [ephemeral](https://docs.stripe.com/api/ephemeral)
- [events](https://docs.stripe.com/api/events)
- [exchange](https://docs.stripe.com/api/exchange)
- [external](https://docs.stripe.com/api/external)
- [fabric](https://docs.stripe.com/api/fabric)
- [file](https://docs.stripe.com/api/file)
- [files](https://docs.stripe.com/api/files)
- [financial](https://docs.stripe.com/api/financial)
- [forwarding](https://docs.stripe.com/api/forwarding)
- [identity](https://docs.stripe.com/api/identity)
- [invoice](https://docs.stripe.com/api/invoice)
- [invoiceitems](https://docs.stripe.com/api/invoiceitems)
- [invoices](https://docs.stripe.com/api/invoices)
- [issuing](https://docs.stripe.com/api/issuing)
- [link](https://docs.stripe.com/api/link)
- [linked](https://docs.stripe.com/api/linked)
- [mandates](https://docs.stripe.com/api/mandates)
- [payment](https://docs.stripe.com/api/payment)
- [payouts](https://docs.stripe.com/api/payouts)
- [plans](https://docs.stripe.com/api/plans)
- [prices](https://docs.stripe.com/api/prices)
- [products](https://docs.stripe.com/api/products)
- [promotion](https://docs.stripe.com/api/promotion)
- [quotes](https://docs.stripe.com/api/quotes)
- [radar](https://docs.stripe.com/api/radar)
- [refunds](https://docs.stripe.com/api/refunds)
- [reporting](https://docs.stripe.com/api/reporting)
- [reviews](https://docs.stripe.com/api/reviews)
- [setup](https://docs.stripe.com/api/setup)
- [shipping](https://docs.stripe.com/api/shipping)
- [sigma](https://docs.stripe.com/api/sigma)
- [sources](https://docs.stripe.com/api/sources)
- [subscription](https://docs.stripe.com/api/subscription)
- [subscriptions](https://docs.stripe.com/api/subscriptions)
- [tax](https://docs.stripe.com/api/tax)
- [terminal](https://docs.stripe.com/api/terminal)
- [test](https://docs.stripe.com/api/test)
- [tokens](https://docs.stripe.com/api/tokens)
- [topups](https://docs.stripe.com/api/topups)
- [transfers](https://docs.stripe.com/api/transfers)
- [treasury](https://docs.stripe.com/api/treasury)
- [webhook](https://docs.stripe.com/api/webhook)

``` python
sapi.account
```

- [account.get](https://docs.stripe.com/api/accounts/retrieve)(expand:
  list = None): *Retrieve account*
- [account.links_post](https://docs.stripe.com/api/account_links/create)(account:
  str = None, collect: str = None, collection_options: dict = None,
  expand: list = None, refresh_url: str = None, return_url: str = None,
  type: str = None): *Create an account link*
- [account.sessions_post](https://docs.stripe.com/api/account_sessions/create)(account:
  str = None, components: dict = None, expand: list = None): *Create an
  Account Session*

``` python
sapi.account.get().keys()
```

    dict_keys(['id', 'object', 'business_profile', 'business_type', 'capabilities', 'charges_enabled', 'company', 'controller', 'country', 'default_currency', 'details_submitted', 'email', 'payouts_enabled', 'settings', 'type'])

You can also call
[`StripeApi`](https://AnswerDotAI.github.io/faststripe/core.html#stripeapi)
directly with the path, verb, parameters, headers, etc:

``` python
prod = sapi('/v1/products', 'POST', data=dict(name='Test Product'))
prod.id, prod.name
```

    ('prod_Tx1xp1BieLA0US', 'Test Product')

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/faststripe/blob/main/faststripe/core.py#L125"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeApi.\_\_getitem\_\_

``` python

def __getitem__(
    k
):

```

*Lookup and call an endpoint by path and verb (which defaults to ‘GET’)*

You can access endpoints by indexing into the object. When using the API
this way, you do not need to specify what type of parameter (route,
query, or post data) is being used. This is, therefore, the same call as
above:

``` python
prod = sapi['/v1/products'](name='Test Product') # defaults to GET
prod.data[0].id, prod.data[0].name
```

    ('prod_Tx1xp1BieLA0US', 'Test Product')

That is all we need in order to have a fully functional Python SDK that
is compliant with the Stripe OpenAPI spec. Kind of insane that in under
100 lines of code, we can get this functionality, which in my opinion is
in some respects even better than the official Stripe Python SDK for the
simple fact that we can see the parameters that the functions take
without looking up the API reference doc online.

Let’s go ahead and try to build with this thing. The simplest payment
system that you can have in Stripe is a one-time payment URL. Here is
how we do this in our new API. First, we have to create a product and
its price.

``` python
prod = sapi.products.post(name='Test Product')
prod.id, prod.name
```

    ('prod_Tx1xOoz9nZNsJP', 'Test Product')

``` python
price = sapi.prices.post(product=prod.id, unit_amount=10_00, currency='usd')
price.id, price.unit_amount, price.currency
```

    ('price_1Sz7ttKGhqIw9PXm6FYt5b9b', 1000, 'usd')

Use the async client to get async calls.

``` python
asapi = StripeApiAsync()
```

``` python
aprod = await asapi.products.post(name='Test Product')
aprod.id, aprod.name
```

    ('prod_Tx1xtPKLT157HW', 'Test Product')

Now we can create our checkout session with a mode of payment which
means that it will only happen once and is not part of any sort of
subscription.

``` python
sapi.checkout
```

- [checkout.sessions_get](https://docs.stripe.com/api/sessions/list)(created:
  ‘str’ = None, customer: ‘str’ = None, customer_details: ‘str’ = None,
  ending_before: ‘str’ = None, expand: list = None, limit: ‘str’ = None,
  payment_intent: ‘str’ = None, payment_link: ‘str’ = None,
  starting_after: ‘str’ = None, status: ‘str’ = None, subscription:
  ‘str’ = None): *List all Checkout Sessions*
- [checkout.sessions_post](https://docs.stripe.com/api/sessions/create)(adaptive_pricing:
  dict = None, after_expiration: dict = None, allow_promotion_codes:
  bool = None, automatic_tax: dict = None, billing_address_collection:
  str = None, branding_settings: dict = None, cancel_url: str = None,
  client_reference_id: str = None, consent_collection: dict = None,
  currency: str = None, custom_fields: list = None, custom_text: dict =
  None, customer: str = None, customer_creation: str = None,
  customer_email: str = None, customer_update: dict = None, discounts:
  list = None, excluded_payment_method_types: list = None, expand: list
  = None, expires_at: int = None, invoice_creation: dict = None,
  line_items: list = None, locale: str = None, metadata: dict = None,
  mode: str = None, name_collection: dict = None, optional_items: list =
  None, origin_context: str = None, payment_intent_data: dict = None,
  payment_method_collection: str = None, payment_method_configuration:
  str = None, payment_method_data: dict = None, payment_method_options:
  dict = None, payment_method_types: list = None, permissions: dict =
  None, phone_number_collection: dict = None, redirect_on_completion:
  str = None, return_url: str = None, saved_payment_method_options: dict
  = None, setup_intent_data: dict = None, shipping_address_collection:
  dict = None, shipping_options: list = None, submit_type: str = None,
  subscription_data: dict = None, success_url: str = None,
  tax_id_collection: dict = None, ui_mode: str = None, wallet_options:
  dict = None): *Create a Checkout Session*
- [checkout.sessions_session_get](https://docs.stripe.com/api/sessions/delete)(session,
  expand: list = None): *Retrieve a Checkout Session*
- [checkout.sessions_session_post](https://docs.stripe.com/api/sessions/update)(session,
  collected_information: dict = None, expand: list = None, metadata:
  object = None, shipping_options: object = None): *Update a Checkout
  Session*
- [checkout.sessions_session_expire_post](https://docs.stripe.com/api/expires/update)(session,
  expand: list = None): *Expire a Checkout Session*
- [checkout.sessions_session_line_items_get](https://docs.stripe.com/api/line_items/delete)(session,
  ending_before: ‘str’ = None, expand: list = None, limit: ‘str’ = None,
  starting_after: ‘str’ = None): *Retrieve a Checkout Session’s line
  items*

``` python
checkout = sapi.checkout.sessions_post(mode='payment', line_items=[dict(price=price.id, quantity=1)],
                                       success_url='https://localhost:5001/success', cancel_url='https://localhost:5001/cancel')
print(f'Payment link: {checkout.url[:64]}...')
```

    Payment link: https://billing.answer.ai/c/pay/cs_test_a1Yg2hX9DHet8IhchVmvU1KG...

Let’s make this process even easier by add a higher level api ontop of
our StripeApi.

## Pagination

First, let’s make it a little bit easier to iterate through existing
objects like customers or products.

The [`paged`](https://AnswerDotAI.github.io/faststripe/core.html#paged)
function provides an iterator that automatically handles pagination for
Stripe API list methods.

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/faststripe/blob/main/faststripe/core.py#L141"
target="_blank" style="float:right; font-size:smaller">source</a>

### paged

``` python

def paged(
    oper, args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Iterate through all pages of a Stripe API operation.*

``` python
ps = L(itertools.islice(paged(sapi.customers.get, limit=2), 2))
cs = L(c for p in ps for c in p.data)
test_eq(len(ps), 2)
test_eq(len(cs), 4)
```

The [`pages`](https://AnswerDotAI.github.io/faststripe/core.html#pages)
function retrieves all items from all pages and returns them as a single
list.

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/faststripe/blob/main/faststripe/core.py#L151"
target="_blank" style="float:right; font-size:smaller">source</a>

### pages

``` python

def pages(
    oper, args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Retrieve all items from all pages of a Stripe API operation.*

Let’s test the pagination with the `customers` endpoint.

``` python
customers = pages(sapi.customers.get, limit=100)
len(customers), customers[0].keys()
```

    (1341,
     dict_keys(['id', 'object', 'address', 'balance', 'created', 'currency', 'customer_account', 'default_source', 'delinquent', 'description', 'discount', 'email', 'invoice_prefix', 'invoice_settings', 'livemode', 'metadata', 'name', 'next_invoice_sequence', 'phone', 'preferred_locales', 'shipping', 'tax_exempt', 'test_clock']))

## Helpers

Great, now let’s make it easier to find products and prices!

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/faststripe/blob/main/faststripe/core.py#L158"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeApi.find_product

``` python

def find_product(
    name:str, limit:int=100, active:str=None, created:str=None, ending_before:str=None, expand:list=None,
    ids:str=None, shippable:str=None, starting_after:str=None, url:str=None
):

```

*Find a product by name*

``` python
sapi.find_product('Test Product')
```

``` python
{ 'active': True,
  'attributes': [],
  'created': 1770055285,
  'default_price': {},
  'description': {},
  'id': 'prod_TuFx0aa85l7sIr',
  'images': [],
  'livemode': False,
  'marketing_features': [],
  'metadata': {},
  'name': 'Test Product',
  'object': 'product',
  'package_dimensions': {},
  'shippable': {},
  'statement_descriptor': {},
  'tax_code': {},
  'type': 'service',
  'unit_label': {},
  'updated': 1770055285,
  'url': {}}
```

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/faststripe/blob/main/faststripe/core.py#L166"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeApi.find_prices

``` python

def find_prices(
    product_id:str, limit:int=100, active:str=None, created:str=None, currency:str=None, ending_before:str=None,
    expand:list=None, lookup_keys:str=None, product:str=None, recurring:str=None, starting_after:str=None,
    type:str=None
):

```

*Find all prices associated with a product id*

``` python
sapi.find_prices(sapi.find_product('Test Product').id)
```

    [{'id': 'price_1SwRRBKGhqIw9PXmcbRkGznA', 'object': 'price', 'active': True, 'billing_scheme': 'per_unit', 'created': 1770055285, 'currency': 'usd', 'custom_unit_amount': {}, 'livemode': False, 'lookup_key': {}, 'metadata': {}, 'nickname': {}, 'product': 'prod_TuFx0aa85l7sIr', 'recurring': {}, 'tax_behavior': 'unspecified', 'tiers_mode': {}, 'transform_quantity': {}, 'type': 'one_time', 'unit_amount': 1000, 'unit_amount_decimal': '1000'}]

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/faststripe/blob/main/faststripe/core.py#L172"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeApi.priced_product

``` python

def priced_product(
    product_name, amount_cents, currency:str='usd', recurring:NoneType=None, description:NoneType=None
):

```

*Create a product and price if they don’t exist*

``` python
prod, price = sapi.priced_product('Test Product', 10_00, 'usd')
prod.name, price.id, price.unit_amount
```

    ('Test Product', 'price_1SwRRBKGhqIw9PXmcbRkGznA', 1000)

Now we can automatically create a product or use an existing one when
create a one time payment link.

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/faststripe/blob/main/faststripe/core.py#L185"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeApi.one_time_payment

``` python

def one_time_payment(
    product_name, amount_cents, success_url, cancel_url, currency:str='usd', quantity:int=1,
    adaptive_pricing:dict=None, after_expiration:dict=None, allow_promotion_codes:bool=None, automatic_tax:dict=None,
    billing_address_collection:str=None, branding_settings:dict=None, client_reference_id:str=None,
    consent_collection:dict=None, custom_fields:list=None, custom_text:dict=None, customer:str=None,
    customer_account:str=None, customer_creation:str=None, customer_email:str=None, customer_update:dict=None,
    discounts:list=None, excluded_payment_method_types:list=None, expand:list=None, expires_at:int=None,
    invoice_creation:dict=None, line_items:list=None, locale:str=None, metadata:dict=None, mode:str=None,
    name_collection:dict=None, optional_items:list=None, origin_context:str=None, payment_intent_data:dict=None,
    payment_method_collection:str=None, payment_method_configuration:str=None, payment_method_data:dict=None,
    payment_method_options:dict=None, payment_method_types:list=None, permissions:dict=None,
    phone_number_collection:dict=None, redirect_on_completion:str=None, return_url:str=None,
    saved_payment_method_options:dict=None, setup_intent_data:dict=None, shipping_address_collection:dict=None,
    shipping_options:list=None, submit_type:str=None, subscription_data:dict=None, tax_id_collection:dict=None,
    ui_mode:str=None, wallet_options:dict=None
):

```

*Create a simple one-time payment checkout*

``` python
checkout = sapi.one_time_payment('Test Product', 10_00, 'https://localhost:5001/success', 'https://localhost:5001/cancel', 'usd')
print(f'Payment link: {checkout.url[:64]}...')
```

    Payment link: https://billing.answer.ai/c/pay/cs_test_a1K2vLpP2I89Df5WdJ8Ks9p8...

Another common use case is subscriptions. Let’s go ahead and create a
version that makes subscription creation just as easy.

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/faststripe/blob/main/faststripe/core.py#L195"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeApi.subscription

``` python

def subscription(
    product_name, amount_cents, success_url, cancel_url, currency:str='usd', interval:str='month',
    adaptive_pricing:dict=None, after_expiration:dict=None, allow_promotion_codes:bool=None, automatic_tax:dict=None,
    billing_address_collection:str=None, branding_settings:dict=None, client_reference_id:str=None,
    consent_collection:dict=None, custom_fields:list=None, custom_text:dict=None, customer:str=None,
    customer_account:str=None, customer_creation:str=None, customer_email:str=None, customer_update:dict=None,
    discounts:list=None, excluded_payment_method_types:list=None, expand:list=None, expires_at:int=None,
    invoice_creation:dict=None, line_items:list=None, locale:str=None, metadata:dict=None, mode:str=None,
    name_collection:dict=None, optional_items:list=None, origin_context:str=None, payment_intent_data:dict=None,
    payment_method_collection:str=None, payment_method_configuration:str=None, payment_method_data:dict=None,
    payment_method_options:dict=None, payment_method_types:list=None, permissions:dict=None,
    phone_number_collection:dict=None, redirect_on_completion:str=None, return_url:str=None,
    saved_payment_method_options:dict=None, setup_intent_data:dict=None, shipping_address_collection:dict=None,
    shipping_options:list=None, submit_type:str=None, subscription_data:dict=None, tax_id_collection:dict=None,
    ui_mode:str=None, wallet_options:dict=None
):

```

*Create a simple recurring subscription*

``` python
sub_checkout = sapi.subscription('Test Subscription Product', 10_00, 'https://localhost:5001/success', 'https://localhost:5001/cancel')
print(f'Payment link: {sub_checkout.url[:64]}...')
```

    Payment link: https://billing.answer.ai/c/pay/cs_test_a1pchuEPwFRZJE2yeH84ciAJ...

**Note:** You’ll want to use Stripe’s webhook functionality for
detecting payment and subscription events. To do so, you’ll utilize the
Python Stripe SDK that the event actually came from stripe.
